YUI.add("common-ui-lozengeDD",function(G){G.namespace("common.ui");var E=G.common.Utils;var A=function(I){var J=this;J.inputUl=null;J.insertBefore=null;J.dummyElement=null;J.targetNode=null;J.selectMultipleLozenges=false;J.composeView=I.composeView,J.composeHeader=I.composeView.baseNode.one(".compose-header");J.firstMove=true;J.allInputBoxes=J.composeHeader.all("div div.ac-input");J.clonedLozenge=null;J.wasHighlighted=false;J.dd=new G.mail.DD({start:J.start,end:J.end,move:J.move,scope:J,node:J.composeHeader});E.setSelect(this.composeHeader,false);};var H=function(J){this.init(J);var I=this.getTargetNode(J);if(I){J.dd.proxy.setXY([-100,-100]);this.dummyElement.setStyle("opacity",0);}};var C=function(N){var O=this,M=O.getTargetNode(N),K=N.dd.proxy,I=O.composeHeader.one(".cm-btn-show-bcc"),J;var L=function(R,P){var Q=O.insertBefore;if(K.inRegion(P)){O.inputUl=P.one("ul");O.allInputBoxes.removeClass("focus");P.addClass("focus");Q=null;J=O.inputUl.all("li");J.each(function(S){if(O.clonedLozenge.inRegion(S)){if(!Q){Q=S;}}});if(!Q){Q=J.item(J.size()-1);}Q.insert(O.dummyElement,Q);}else{if(P.hasClass("focus")){P.removeClass("focus");O.inputUl=null;}}O.insertBefore=Q;};if(K){if(O.firstMove){O.firstMove=false;M.setStyle("display","none");O.composeHeader.all(".hLozenge").each(function(P){P.removeClass("focus");});}K.setStyle("top",N.pageY);K.setStyle("left",N.pageX);K.setXY([N.pageX,N.pageY]);if(K.inRegion(O.composeHeader)){if(K.inRegion(I)){O.composeView._bccSwitch(true);}else{O.allInputBoxes.each(function(P){L(N,P);});}}}};var B=function(K){var L=this,J=this.getTargetNode(K),I=L.insertBefore;if(J){K.dd.proxy.remove().destroy(true);if(L.inputUl&&I){J.remove();L.inputUl.get("parentNode").removeClass("focus");if(!this.selectMultipleLozenges){I.insert(J,I);}else{J.each(function(M){I.insert(M,I);M.removeClass("focus");});}L.composeView.dirty=true;}else{if(this.wasHighlighted){J.addClass("focus");}}L.dummyElement.remove().destroy(true);L.dummyElement=null;J.setStyle("display","inline-block");J.removeAttribute("style");K.dd.proxy=null;L.targetNode=null;L.selectedLozenges=false;L.firstMove=true;L.insertBefore=null;K.notDragging=false;L.wasHighlighted=false;L.selectMultipleLozenges=false;}};var D=function(I){return this.targetNode||null;};var F=function(O){var N=this,Q,J=0,I,P=O.dd.proxy,M;var L=function(){K(O);if(N.targetNode){var R=N.targetNode.cloneNode(true);R.replaceClass("hLozenge","dd-hLozengeBox");R.one("input").remove();O.dd.proxy=G.Node.create('<div style="position:absolute"></div>');O.dd.proxy.appendChild(R);N.clonedLozenge=R;N.dummyElement=N.targetNode.cloneNode(true);}};var K=function(S){var T,R=S.target;T=(G.Node.getDOMNode(R)).nodeName;if(T=="LI"&&R.hasClass("hLozenge")){N.targetNode=R;}else{N.targetNode=R.ancestor("li.hLozenge");}return N.targetNode;};Q=O.target.ancestor("ul");if(!Q){N.targetNode=null;}else{if(O.target.hasClass("lozenge-edit")){N.targetNode=null;O.notDragging=true;}else{if(Q.one("li.focus")){M=K(O);N.targetNode=Q.all("li.focus");J=N.targetNode.size();if(J==1||!M.hasClass("focus")){if(M.hasClass("focus")){N.wasHighlighted=true;}L();}else{N.wasHighlighted=true;O.dd.proxy=G.Node.create('<div style="z-index: 999" class="contactDragProxy"><span></span><b class="counter">'+J+"</b></div>");N.clonedLozenge=O.dd.proxy;if(!N.dummyElement){N.dummyElement=N.targetNode.item(0).cloneNode(true);}N.selectMultipleLozenges=true;}}else{L();}}}if(O.dd.proxy){G.one("body").append(O.dd.proxy);}};A.prototype={start:H,end:B,move:C,getTargetNode:D,init:F};G.common.ui.lozengeDD=A;},"1.0.0",{requires:["common-ui-dd","common-utils"]});