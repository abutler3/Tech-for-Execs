YUI.add("mail-service-uploader-form",function(E){E.namespace("mail");var D=E.mail.UploaderService.logIt;window.UploaderService=window.UploaderService||E.mail.UploaderService;var F=parseInt(NeoConfig.formUploaderResponseTimeout,10)||1500000,C=parseInt(NeoConfig.formUploaderRedirectInterval,10)||2000,A=15;var B=function(G){var H=this;H.uploaderType=E.mail.UploaderService.UPLOADER_TYPE_FORM;H.uploaderID=G.uploaderID||(+new Date);H.attView=G.attView;H.uiForm=G.attForm;H.attachNode=G.attachNode||H.uiForm;H.uiTab=G.tab;H.dsCDO=G.cdo;H.skipDefault=G.skipDefault||0;if(!G.skipDefault){H.attView.uploader=H;}H.attView.formUploader=H;H.uiTab.uploader=H;D("Form uploader: Instance created");};B.prototype.createUploadIframe=function(J){var K=new Date(),L=K.getTime(),I=E.Node.create("<iframe id='"+L+"' name='"+L+"' style='display:none'></iframe>"),G,H;this.uiTab.append(I);J.iframe=I;G=I._node;H=G.contentDocument||G.contentWindow.document;H.open("text/html","replace");H.write("<script>window.onunload=function(){parent.UploaderService.handleIframeUpdate("+this.uploaderID+", "+L+", "+J.cdoIndex+");};<\/script>");H.close();return L;};B.prototype.updateUI=function(){var K=this,I=K.attachNode.one(".attachment-button-file")||K.attachNode.one("input"),G=K.attachNode.one(".attachment-button-attach"),H=G.one("a")||G.one("i"),J=K.attachNode.one(".attach-btn-menu");if(NeoConfig.multiAttachEnabled=="1"){I.setAttribute("multiple",true);}I&&I.setStyle("display","block");K.inputChangeHandle=I.on("change",function(L){K.handleFileInput(L);});if(!K.skipDefault){H&&H.setContent(strings.str_comp_attach_singular);if(!J||J.hasClass("hidden")){G.addClass("right");}}D("Form uploader: UI has been updated");};B.prototype.failFunc=function(G,H){var I=this;D('<B style="color:red">Form uploader: CDO Item: '+G.cdoIndex+" : "+H+"</B>");E.mail.UploaderUtils.setAttachmentState({item:G,state:H,uploader:I});G.size.original=0;G.processed=true;I.dsCDO.fire("CDO_ATTACHMENT_PROCESSED",G.cdoIndex);};B.prototype.retryAttachment=function(G){var I=this,H=I.uiForm.one(".attachment-button-file");E.use("node-event-simulate",function(){H.simulate("click",{});I.dsCDO.once("CDO_ATTACHMENT_FILES_SELECTED",function(J){I.dsCDO._removeAttachment(G);});});};B.prototype.handleFileInput=function(P){var O=this,L=P.currentTarget,T,I,Q=L._node.files,S,U,M,R,N,K,J,H,G;O.dsCDO.fire("CDO_ATTACHMENT_FILES_SELECTED");if(NeoConfig.multiAttachEnabled=="1"&&Q&&Q.length){D("Form uploader: "+Q.length+" files selected");for(S=0;S<Q.length;S++){U=Q.item(S);I={filename:U.name||U.fileName||"<no name>",mimetype:U.type||"",state:{},size:{original:U.fileSize||"<no size>"}};O.dsCDO._addAttachment(I);if(S==0){T=I.cdoIndex;}}}else{H=L.get("value");if(!H){return;}G=new E.common.Utils.Stopwatch("AttachmentUpload");G.attType="form";I={filename:H,state:{},size:{original:0},stopwatch:G};O.dsCDO._addAttachment(I);T=I.cdoIndex;D("Form uploader: "+H+" selected (CDO item: "+T+")");}M=O.createUploadIframe(I);O.uiForm.set("target",M);R=document.location.host;K=NeoConfig&&NeoConfig.buildSuffix?NeoConfig.buildSuffix:0;N=[NeoConfig.launch_protocol,R,"/neo/php/attach.php?uploaderID=",O.uploaderID,"&b=",K,"&cdoidx=",T,"&ifid=",M].join("");J=[E.mail.UploaderService.UPLOAD_URL_BASE,"?resulturl=",encodeURIComponent(N)].join("");O.uiForm.set("action",J);O.uiForm._node.submit();E.mail.UploaderService.rs.intlStat("FormUploader","onFileSelect");if(NeoConfig.low_bandwidth){}else{I.timeout=setTimeout(function(){O.failFunc(I,"uploaderFormUploadNoResponse");},F);}O.uiForm._node.reset();};B.prototype.handlePostRedirectResponse=function(K){var J=0,G=this.dsCDO,I=K[J++],H;while(I){I.processed=true;H=G.get("attachments")[I.cdoIndex].stopwatch;if(H){H.attSize=I.size.original;H.stop();}D("Form Uploader: CDO item "+I.cdoIndex+": Server response received!");G._updateAttachment(I.cdoIndex,I);I=K[J++];}};B.prototype.cancelUpload=function(H){var L=this,J=L.dsCDO.get("attachments"),I=J[H],G=I.iframe,K=G._node&&G._node.contentDocument||G._node&&G._node.contentWindow.document;if(I.timeout){clearTimeout(I.timeout);}K&&K.open("text/html","replace");K&&K.write("<div></div>");K&&K.close();G.remove();G.destroy();L.failFunc(I,"uploaderFormUserCancelled");};B.prototype.handleIframeUpdate=function(W,V){var N=this,S=this.dsCDO.get("attachments"),T=S[V],O=T.iframe,R=O._node,U=R.contentDocument||R.contentWindow.document,Q=R.contentWindow||U,I=Q.location,M,K=0,P,H,G=3,L=0;if(T){if(T.timeout){clearTimeout(T.timeout);}}else{D("Form uploader: We received an iframe update for a non-existent attachment");}function J(Y){L+=1;if(L>=G){if(T.timeout){clearInterval(T.timeout);}N.failFunc(T,Y);var X=E.UA.ie?"IE"+E.UA.ie:(E.UA.safari?"Safari"+E.UA.safari:(E.UA.chrome?"Chrome"+E.UA.chrome:(E.UA.gecko?"Firefox"+E.UA.gecko:"unknown")));E.mail.UploaderService.rs.intlStat("UploaderService","AttachUploadIframeError_"+E.UA.os+"-"+X);}}P=function(){M=Q&&Q.location;try{H=M.pathname;}catch(X){J("uploaderFormUploadServerHangUp_Error");return;}if(!H){J("uploaderFormUploadServerHangUp");return;}if(H.indexOf("attach.php")!=-1){if(T.timeout){clearInterval(T.timeout);}T.processed=true;}else{if(M==I){}else{if(H.indexOf("ya/upload")!=-1){}else{if(T.timeout){clearInterval(T.timeout);}N.failFunc(T,"uploaderFormUploadUnexpectedResponse");}}K++;if(K==A){if(T.timeout){clearInterval(T.timeout);}N.failFunc(T,"uploaderFormUploadTimeout");}}};if(NeoConfig.low_bandwidth){}else{T.timeout=setInterval(P,C);}};E.mail.UploaderService.handleIframeUpdate=function(H,I,G){var J=E.mail.UploaderService.uploadersCreated[H];D("Uploader Service: Received an iframe update for CDO item "+G);J.handleIframeUpdate(I,G);};E.mail.Uploader=E.mail.UploaderForm=B;D("Form uploader: Component loaded");},"1.0.0");