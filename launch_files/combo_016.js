YUI.add("mail-ui-mailpane-next-prev",function(E){E.namespace("mail.ui");var B=E.mail,A=B.ui,C=E.common;var D=function(F){var G=this;};E.mix(D.prototype,{stepMessage:function(I,H,F,G){},dialogThenStep:function(H,I,F,G){}});E.mail.ui.MailPaneNextPrev=D;},"1.0.0",{requires:["mail-ui-common-string-utils","common-utils","common-utils-stats"]});YUI.add("mail-ui-messagepane-next-prev",function(E){E.namespace("mail.ui");var O=E.mail,I=O.ui,B=O.model.DataStore.Messages,P=O.Controller.Messages,K=E.common,H=I._MessagePane,G=I.MessageList.prototype.columns;var D=function(){var Q=this;D.superclass.constructor.call(Q,attr);};function N(T,S,Q,R,U){var V=this;if(V.stepTimer){V.stepTimer.cancel();}if(T=="next"){V.nextPrevCounter++;}else{V.nextPrevCounter--;}V.stepTimer=E.Lang.later(200,V,V.findNextMessage,[S,0,Q,R,U]);}function C(j,b,Z,Q,R){var h=this,n,a,g=h.fid,l=h.stepIndex,f=h.arrMessageSequence,W,Y=f&&f.length||0,k,T,U=0,j=j||0,S;h.stepTimer=0;if(h.nextPrevCounter==0||h.isStepping){return;}h.isStepping=1;a=h.nextPrevCounter;n=a>0?"next":"prev";h.nextPrevCounter=0;try{T=l+a;if(typeof l!="undefined"&&l!=null&&f&&f[T]){U=f[T];h.stepIndex=T;if(Z&&!b){h.arrMessageSequence.splice(l,1);h.stepIndex=(T>0)?T--:T;}}else{for(k=0;k<Y;k++){if((W=f[k])&&((W.mid==h.message.mid)||(B.isSearchMid(W.mid)&&B.getPermMidPart(W.mid)==B.getPermMidPart(h.message.mid)))){T=k+a;if(T<Y&&T>=0){U=f[T];h.stepIndex=T;}if(Z&&!b){h.arrMessageSequence.splice(k,1);h.stepIndex=(T>0)?T--:T;}break;}}}if(h.searchQuery&&NeoConfig.enableMSWS&&U){h.searchItemIndex=(n=="prev")?h.searchItemIndex-1:h.searchItemIndex+1;}if(!U){if(h.searchQuery&&g!="%40S%40Search"){if(j){j(U);}else{if(NeoConfig.enableMSWS&&h.searchQuery){var d=function(e){var i=this;i.searchListMgr.store(e.response);i.arrMessageSequence=i.searchListMgr.getAllCachedItems();i.searchItemIndex=(n=="prev")?i.searchItemIndex-1:i.searchItemIndex+1;U=i.arrMessageSequence[i.searchItemIndex];if(U){i.updateMessageInTab(U.fid,U,(n=="prev"?-1:1));}i.isStepping=0;};var c=h.searchListMgr.getCacheInfo()["serverTotal"],V=h.searchRequestAttrs,X=((V.start+50)<c)?V.start+50:V.start;h.searchItemIndex=h.searchListMgr.getItemIndex(h.message.mid);if((h.searchItemIndex==0)||(h.searchItemIndex==c-1)){h.displayError(n,"%40S%40Search");h.isStepping=0;}else{h.searchRequestAttrs.start=X;var o=new E.mail.ui.SearchRequest(h.searchRequestAttrs);o.execute(d,h);}}else{h.displayError(n,"%40S%40Search");h.isStepping=0;}}}else{h.updateSequenceArray(a,T,n,j,b,Z,R);}}else{if(U&&U.mid!=h.message.mid){if(!b){S=h.updateMessageInTab(U.fid||g,U,(n=="prev"?-1:1),Q);}if(j&&(S||!R)){j(U);}if(!b){h.isStepping=0;}}else{h.isStepping=0;}}}catch(m){h.isStepping=0;}}function F(V,S,U,T){if(!S||!V){return;}var X=this,W,Q=new K.Utils.Stopwatch("MsgInTab");Q.mid=S.mid;X.stopwatch=Q;var R=E.mail.Tabs.getTab(function(Y){return Y.msgPane&&Y.msgPane.fullView&&(S.mid==Y.msgPane.get("message").message.mid);});if(R){R.set("active",1,{noScroll:false});X.set("close",1,{noScroll:false});return false;}if(X.fullView&&NeoConfig.fullPage){if(T){W=E.config.win||window;W.scrollTo(0,0);}}X.set("message",{message:B.toMessage(V,S),fid:V});X.once("renderComplete",function(Y){if(Y.currentTarget.message.mid==Q.mid){Q.stop();delete X.stopwatch;}E.Lang.later(0,X,X.preCacheLinear,U);});return true;}function M(U){if(U!=1&&U!=-1){return;}var V=this,R=V.arrMessageSequence,Q=[],S,T=O&&O.common&&O.common.cachewarmer;if(!T||!R){return;}if((S=R[V.stepIndex+U])&&!B.isCached(V.fid,S.mid)){Q.push({mid:S.mid});}Q.length&&T.preFetchMessages(V.fid,0,100,Q);Q=null;T=null;}function A(V,d,c,R,Z,Q,U){var W=this,T=W.sortedColumn||G.date,S=W.fid,Y=W.searchQuery||"",b=V>0?V*100+1:V*-100+1,X={sortKey:T.sortKey,sortOrder:T.sortOrder,groupBy:T.groupBy},a={success:function(j){try{if(W.get("close")){W.isStepping=0;return;}var q=j.messageInfo,n=q.length,f=j.folder.folderInfo,h=f.fid,l,p,m,k=0,g=0;W.arrMessageSequence=q;for(l=0;l<n;l++){if((p=q[l])&&(p.mid==W.message.mid)){m=l+V;if(m<n&&m>=0){k=q[m];W.stepIndex=m;}else{g=1;}if(Q&&!Z){W.arrMessageSequence.splice(l,1);W.stepIndex=(d>0)?d--:d;}break;}}if(g&&(!R||U)){W.displayError(c,h);}else{if(g&&R&&c=="prev"){W.arrMessageSequence=0;W.stepIndex=null;if(Z){W.isStepping=0;}else{W.set("close",1);}R(k);}else{if(g&&R){W.stepIndex=null;W.arrMessageSequence=0;W.isStepping=0;W.nextPrevCounter=V*-1;W.findNextMessage(R,Z,Q);}else{if(k&&k.mid!=W.message.mid){if(!Z){W.updateMessageInTab(h,k,(c=="prev"?-1:1));}if(R){R(k);}}}}}if(!Z){W.isStepping=0;}}catch(o){}},failure:function(){}};if(S=="%40S%40Search"){K.Utils.merge(X,{search:{query:Y},numInfo:600});P.search(X,a);}else{setTimeout(function(){P.list(K.Utils.merge(X,{loc:"centerOn",fid:S,numInfo:b,offsetMid:W.message.mid}),a);},0);}}function J(Q,R){E.use("common-ui-dialog-helper",function(V){var U=(Q=="next")?strings.str_error_last_message:strings.str_error_first_message,S=Q=="next"?strings.str_modal_last_msg_title:strings.str_modal_first_msg_title,T=O.model.DataStore.Folders.get(R);if(!T){T={fid:R};}else{T=T.folderInfo;}K.ui.DialogHelper.alert({hd:S,bd:K.Utils.substitute(U,{folder_name:I.common.StringUtils.getSystemFolderName(T.fid,T.name)})});});}function L(T,U,R,S){var V=this,Q;R.afterHandle=function(W){if(W&&W.targetMsg){V.updateMessageInTab(V.fid,W.targetMsg,1);}V.isStepping=0;V.stepIndex=null;V.arrMessageSequence=null;};R.cancelCbk=function(){V.isStepping=0;V.stepIndex=null;};Q=function(W){R.afterHandleParams={targetMsg:W};T.handleUI(R,V.fid,null,[U?U.message:null]);};V.nextPrevCounter++;V.findNextMessage(Q,1,S);}E.extend(D,I.MailPaneNextPrev,{stepMessage:N,findNextMessage:C,updateSequenceArray:A,updateMessageInTab:F,dialogThenStep:L,preCacheLinear:M,displayError:J});E.mix(H.prototype,D.prototype);},"1.0.0",{requires:["mail-ui-common-string-utils","mail-ui-messagepane-base","mail-ui-mailpane-next-prev","mail-model-datastore","mail-controller-messages","mail-ui-messagelist-base","common-utils","common-utils-stats"]});