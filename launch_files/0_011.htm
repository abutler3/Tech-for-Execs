<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<script src="0_data_011/om-min.js"></script>
<script>
    var data = null,
        openmail = window.openmail || {};

    onload = function() {
        /**/

        openmail.Application.setListener( {event:"compose.sendstart"}, function(args) {

	        /**
	         * Determines if list can be created of not
	         * 1. there should be more than 1 unique email ids
	         * 2. All the email ids shouldnt belong to same category
	         */
            var isListCreatable = function(messagedata, args) {
                var proceedArgs = {
                        view: 'sendconfirm.html',
                        height: '80px',
                        closeTabOnViewClose: true
                    },

                    contacts = [].concat(messagedata.to, messagedata.cc),
                    contactsLength = contacts.length,
                    contact = null,
                    nonContact = false,
                    contactIds = [],
                    emails = {},
                    uniqueEmailCount = 0,
                    categories = [],

                    cb = function(result) {
                        var existingContacts = result.data,
                            existingContactsLength = existingContacts.length,
                            catsLength, cats;

                        /**/
                        /**/

                        /**/

                        /**
                         * For each contact, read all the categories.
                         * Keep track of number of occurance of each category
                         */
                        while (existingContactsLength--) {
                            cats = existingContacts[existingContactsLength].categories;
                            catsLength = cats ? cats.length : 0;

                            /**/

                            while (catsLength--) {
                                var cat = cats[catsLength].name;
                                /**/

                                if (categories[cat]) {
                                    categories[cat]++;
                                    /**/

                                    /**
                                     * If total occurances of a category equals to unique number of contacts,
                                     * this means, there exists at least one category containing all
                                     * the emailIds (contacts) under consideration. So, do not load app
                                     */
                                    if (categories[cat] === uniqueEmailCount) {
                                        args.cancel();
                                        return;
                                    }
                                } else {
                                    categories[cat] = 1;
                                }
                            }
                        }

                        //Now you can load app
                        args.proceed(proceedArgs);
                    };

                while (contactsLength--) {
                    contact = contacts[contactsLength];
                    if (!emails[contact.email]) {
                        if (contact.contactId && contact.contactId > 0) {
                            contactIds.push(contact.contactId);
                        } else {
                            //there is an email address that is not in the address book already.
                            //We can use this to avoid category lookup.
                            nonContact = true;
                        }

						//associative array to keep track of unique email ids
                        emails[contact.email] = true;
                        uniqueEmailCount++;
					}
                }

                /**/

                //Number of unique email ids should be more than 2
	            if(uniqueEmailCount < 3) {
                    /**/
		        	args.cancel();
					return;
                }

                //if nonContact stays false, that means all contacts are real contacts, so we need to check category
                if (!nonContact) {
                    /**/
                    //fetch contacts objects from contacts cache

                    openmail.Application.callWebService({
                                url: 'apps://',
                                method: 'GET',
                                parameters: { cmd: 'contacts.command', args: { cmd: 'getContactsByIds', args: [contactIds] }}
                            }, cb);

                } else {
                    //if there is a nonContact, there is no way it is part of a category, so proceed.
                    args.proceed(proceedArgs);
                }
            };

            /**/

	            try {
	                var data = args.data,
	                    messagedata = {
	                        mid: data.messageid,
	                        from: data.from,
	                        to: data.recipients.to,
	                        cc: data.recipients.cc,
	                        subject: data.subject
	                    };

                    isListCreatable(messagedata, args);
	            }
	            catch (e) {
                    /**/
	            }
            });
        };
    </script>
</head>
<body>
<!-- Build 1185 01/04/2012 11:49 AM PST -->


</body></html>